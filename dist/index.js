"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var RxDB=require("rxdb"),mobx=require("mobx"),consola=_interopDefault(require("consola")),Subscriber=_interopDefault(require("rxcollection-subscriber")),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function __decorate(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(s=(o<3?n(s):3<o?n(t,r,s):n(t,r))||s);return 3<o&&s&&Object.defineProperty(t,r,s),s}function __awaiter(o,s,a,u){return new(a=a||Promise)(function(e,t){function r(e){try{n(u.next(e))}catch(e){t(e)}}function i(e){try{n(u.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((u=u.apply(o,s||[])).next())})}function __generator(r,i){var n,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(r,a)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function __spreadArrays(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),n=0;for(t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,n++)i[n]=o[s];return i}var strings,numbers,arrays,objects,env=String(process.env.NODE_ENV),version=require("../package.json").version,build={db:{name:"Lodger/",adapter:"memory",password:"l0dg3rp4$$",ignoreDuplicate:Boolean("test"===env)}},taxonomii={defaults:{criteriu:{limit:25,index:0,sort:{},find:null}},asociatii:{criteriu:{limit:100}}},config={version:version,taxonomii:taxonomii,build:build},LodgerError=function(i){function n(e,t){var r;return t&&(e=String(e).replace("%%",'"'+JSON.stringify(t)+'"')),r=i.call(this,e)||this,Object.setPrototypeOf(r,n.prototype),r}return __extends(n,i),n}(Error);switch(env){default:RxDB.plugin(require("pouchdb-adapter-memory"));break;case"production":RxDB.plugin(require("pouchdb-adapter-leveldb"))}!function(e){e[e.search=0]="search",e[e.select=1]="select",e[e.string=2]="string",e[e.text=3]="text",e[e.textarea=4]="textarea"}(strings=strings||{}),function(e){e[e.date=0]="date",e[e.dateTime=1]="dateTime",e[e.number=2]="number"}(numbers=numbers||{}),function(e){e[e.array=0]="array",e[e.contactFields=1]="contactFields",e[e.contoare=2]="contoare",e[e.distribuire=3]="distribuire",e[e.furnizori=4]="furnizori",e[e.selApartamente=5]="selApartamente",e[e.servicii=6]="servicii",e[e.scari=7]="scari"}(arrays=arrays||{}),function(e){e[e.bani=0]="bani",e[e.object=1]="object",e[e.organizatie=2]="organizatie"}(objects=objects||{}),String.prototype.stripLeading$=function(){return 0!==this.indexOf("$")?String(this):String(this.replace("$","").trim().stripLeading$())},String.prototype.customSplit=function(){var e=this.split("/");return{what:e[0],mutation:e[1]}},String.prototype.slugify=function(){return this.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")},String.prototype.toRxDBType=function(){var e=this.toString();return-1<Object.keys(strings).indexOf(e)?"string":-1<Object.keys(objects).indexOf(e)?"object":-1<Object.keys(numbers).indexOf(e)?"number":-1<Object.keys(arrays).indexOf(e)?"array":"string"},String.prototype.plural=function(){return String(this+"i")};var Errors,S={String:String},String$1=S.String,Field=function(){function e(e){var t=this;if(this.type="string",this.storage="db",this.value=function(){return t.default||void 0},e){var r=e.index,i=e.ref,n=e.indexRef,o=e.type,s=e.step,a=e.required,u=e.v,c=e.value;if(this.type=String$1(o||"").toRxDBType(),r&&(this.index=!0),i&&(this.ref=i,this.items={type:"string"},n&&(this.index=n)),void 0!==s){if("number"!==this.type)throw new LodgerError('Type must be "number" for .step');this.multipleOf=s}a&&(this.v=a&&u&&u.indexOf("required")<0?u:"required|"+u),this.default="function"==typeof e.default?e.default():e.default;var l=this.storage;c&&"function"==typeof c&&(this.value=c.bind({storage:l}))}}return Object.defineProperty(e.prototype,"rxSchema",{get:function(){var t=this,r={},i=["storage","value","default","v"];return Object.keys(this).forEach(function(e){void 0!==t[e]&&(-1<i.indexOf(e)||(r[e]=t[e]))}),r},enumerable:!0,configurable:!0}),e}();!function(e){e.missingProps="Missing properties on schema %%",e.propExists='Property "%%" already exists',e.idUndef="ID for field %% cannot be undefined",e.invalidField="Invalid field %% supplied"}(Errors=Errors||{});var Errors$1,Schema=function(){function e(e,t,r){var i=this;if(this.name=e,this.type="object",this.version=0,this.properties={},this.required=[],!t||!Object.keys(t).length)throw new LodgerError(Errors.missingFields,{name:e});Object.keys(t).map(function(e){return i.add(t[e].id||e,t[e])})}return e.prototype.add=function(e,t){if(!e)throw new LodgerError(Errors.idUndef,t);if(this.properties[e])throw new LodgerError(Errors.propExists,e);if(t&&!t.rxSchema)throw new LodgerError(Errors.invalidField,t);var r=t.rxSchema,i=t.v;if("db"===t.storage){var n=i&&-1<i.indexOf("required");this.properties[e]=r||{},n&&this.required.indexOf(e)<0&&this.required.push(e)}},Object.defineProperty(e.prototype,"ids",{get:function(){return Object.keys(this.properties)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"indexables",{get:function(){var t=this;return this.ids.filter(function(e){return t.properties[e].index})},enumerable:!0,configurable:!0}),e}();!function(e){e.invalidRequested="Invalid file requested: %%",e.invalidName="Invalid name supplied: %%",e.missingFields="Missing fields on form %%"}(Errors$1=Errors$1||{});var Errors$2,db,Form=function(){function e(e,t){var r=this;this.opts=t,this._onsubmit=[],this.$active=!1;var i=e||{name:"untitled",fields:{}},n=i.fields,o=i.name;this.name=o,this.fields=__assign({},n),this.plural=this.name.plural(),n&&Object.keys(n).map(function(e){r.fields[e]=new Field(n[e])}),!t||t.captureTimestamp&&(this.fields.createdAt=new Field({type:"dateTime",index:!0,excludeFrom:["addForm","editForm"],showInList:"secondary"}),this.fields.updatedAt=new Field({type:"dateTime",index:!0,excludeFrom:["addForm","editForm"],showInList:"secondary"}));this.schema=new Schema(o,this.fields),this.onsubmit=function(){}}return Object.defineProperty(e.prototype,"data",{get:function(){return Object.assign.apply(Object,__spreadArrays([{}],Object.keys(this.fields)))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldsIds",{get:function(){return Object.keys(this.fields)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onsubmit",{set:function(e){this._onsubmit.push(e.bind(this))},enumerable:!0,configurable:!0}),e.prototype.value=function(r){var i=this,n={};return this.fieldsIds.forEach(function(e){var t=i.fields[e];"db"===t.storage&&(n[e]=t.value(r))}),n},e}();function notify(e){if(this&&"function"==typeof this.dispatch&&this.actions.notify)this.dispatch("notify",e);else{var t=e.type,r=e.text;if(consola[t](r),"error"===t)throw new Error(r)}}(Errors$2||(Errors$2={})).noDB="Please setup a DB first!";var Taxonomy=function(){function e(e,t,r){this.form=e,this.options=r,this.lastItems=[],Object.defineProperty(this,"collection",{enumerable:!1,writable:!1,value:t})}return Object.defineProperty(e.prototype,"last",{get:function(){return this.lastItems[0]},set:function(e){e?this.lastItems.unshift(e):this.lastItems.shift()},enumerable:!0,configurable:!0}),Object.defineProperty(e,"db",{set:function(e){db=e},enumerable:!0,configurable:!0}),e.destroy=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return db?[4,db.destroy()]:[2];case 1:return e.sent(),[2]}})})},Object.defineProperty(e.prototype,"plural",{get:function(){return this.form.plural},enumerable:!0,configurable:!0}),e.init=function(f,d){return void 0===d&&(d={}),__awaiter(this,void 0,void 0,function(){var t,r,i,n,o,s,a,u,c,l;return __generator(this,function(e){switch(e.label){case 0:if(!db)throw new LodgerError(Errors$2.noDB);e.label=1;case 1:return e.trys.push([1,3,,4]),t=f.name,r=f.fields,i=f.methods,n=f.statics,o=d.timestamps,s=new Form({name:t,fields:r},{captureTimestamp:o}),a=s.schema,u={name:t,schema:a,methods:i,statics:n},[4,db.collection(u)];case 2:return c=e.sent(),[2,new this(s,c,d)];case 3:throw l=e.sent(),new LodgerError(l);case 4:return[2]}})})},Object.defineProperty(e.prototype,"name",{get:function(){return this.collection.name},enumerable:!0,configurable:!0}),e.prototype.trash=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.last===t&&(this.last=void 0),[4,this.collection.findOne(t).remove()];case 1:return[2,e.sent()]}})})},e.prototype.put=function(c){return __awaiter(this,void 0,void 0,function(){var t,r,i,n,o,s,a,u;return __generator(this,function(e){switch(e.label){case 0:if(!c||Object.keys(c).length<1)throw new LodgerError("Invalid doc supplied %%",{doc:c});t=c._id?"upsert":"insert",i=(r=this).name,(n=r.options)&&n.timestamps&&Object.assign(c,((u={})["insert"===t?"createdAt":"updatedAt"]=(new Date).getTime(),u)),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.collection[t](c)];case 2:return o=e.sent(),s=o._id,this.last=s,notify({type:"success",text:"["+t+"] "+i+"!"+(-1<["dev","test"].indexOf(env)?"("+s+")":"")}),[2,o];case 3:return a=e.sent(),notify({type:"error",text:String(a)}),[3,4];case 4:return[2]}})})},Object.defineProperty(e.prototype,"config",{get:function(){var e=config.taxonomii,t=e.defaults;return e[this.name]||t},enumerable:!0,configurable:!0}),__decorate([mobx.observable],e.prototype,"lastItems",void 0),__decorate([mobx.computed],e.prototype,"last",null),e}(),STaxonomy=function(t){function e(){var e=t.apply(this,arguments)||this;return e.subscribers={},e}return __extends(e,t),e.init=function(){return t.init.apply(this,arguments)},Object.defineProperty(e.prototype,"data",{get:function(){return this.subscribers},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"subscribed",{get:function(){return 0<Object.keys(this.subscribers).length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"defaultCriteria",{get:function(){return t.prototype.config.criteriu},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(e,t){void 0===e&&(e="main"),this.subscribers[e]||(this.subscribers[e]=new Subscriber(this.collection,t))},e.prototype.unsubscribe=function(e){void 0===e&&(e="main");var t=this.subscribers[e];try{t.kill&&t.kill()}catch(e){}delete this.subscribers[e]},e.prototype.unsubscribeAll=function(){var t=this,e=this.subscribers;if(!e||!Object.keys(e).length)throw new LodgerError("no subs");Object.keys(e).forEach(function(e){t.unsubscribe(e)})},e}(Taxonomy);!function(e){e[e.Apartament=0]="Apartament",e[e.Asociatie=1]="Asociatie",e[e.Bloc=2]="Bloc",e[e.Cheltuiala=3]="Cheltuiala",e[e.Contor=4]="Contor",e[e.Factura=5]="Factura",e[e.Furnizor=6]="Furnizor",e[e.Incasare=7]="Incasare",e[e.Serviciu=8]="Serviciu",e[e.Utilizator=9]="Utilizator"}(exports.Taxonomii||(exports.Taxonomii={}));var Forms,taxonomies=Object.keys(exports.Taxonomii).filter(function(e){return"number"==typeof exports.Taxonomii[e]});!function(e){e[e.Feedback=0]="Feedback",e[e.Financiar=1]="Financiar",e[e.Preferinte=2]="Preferinte"}(Forms=Forms||{}),function(e){e.missingDB="Missing database",e.invalidPluginDefinition="Invalid plugin definition",e.pluralsAlreadyDefined="Plurals are already defined, aborting",e.missingCoreDefinitions="Invalid Lodger build. Missing core definitions",e.invalidPreferenceIndex="Invalid preference index supplied",e.invalidPropertySupplied="Invalid property supplied",e.noPlural="Could not find plural definition for %%",e.missingData="Missing data %%",e.couldNotWriteFile="Cannot write file"}(exports.Errors||(exports.Errors={}));var plugins=[],Lodger=function(){function s(e,t){void 0===e&&(e=e),void 0===t&&(t=[]),this.plugins=t,Object.defineProperties(this,e)}return s.prototype.put=function(e,t){this[e].put(t)},s.prototype.subscribe=function(e,t,r){var i=this;void 0===r&&(r="main"),Object.keys(e).forEach(function(e){i.taxonomies[e].subscribe(r,t)})},s.build=function(o){return void 0===o&&(o=__assign({},config.build)),__awaiter(this,void 0,void 0,function(){var t,r,i,n=this;return __generator(this,function(e){switch(e.label){case 0:return t=STaxonomy,[4,RxDB.create(o.db)];case 1:for(i in t.db=e.sent(),r=[],exports.Taxonomii)r.push(i);return[2,new s(Object.assign.apply(Object,__spreadArrays([{}],r.map(function(i){return __awaiter(n,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return r={},t=i,[4,STaxonomy.init(require("./.schemas/"+i))];case 1:return[2,(r[t]=e.sent(),r)]}})})}))),plugins)]}})})},s.use=function(e){if(!e||"object"!=typeof e)throw new LodgerError(exports.Errors.invalidPluginDefinition);e.name;plugins.push(e)},s.prototype.destroy=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.unsubscribeAll()];case 1:return e.sent(),[4,STaxonomy.destroy()];case 2:return e.sent(),[2]}})})},s.prototype.export=function(t,e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.db.dump()];case 1:return e.sent(),t=t||require("os").homeDir+"/downloads/",[2]}})})},s.prototype.import=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},Object.defineProperty(s.prototype,"subscribedTaxes",{get:function(){return subscribedTaxes},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"activeReferencesIds",{get:function(){var t=this.store.getters;return function(e){return assignRefIdsFromStore({references:e,getters:t})}},enumerable:!0,configurable:!0}),s}();exports.Lodger=Lodger,exports.notify=notify,exports.taxonomies=taxonomies;
